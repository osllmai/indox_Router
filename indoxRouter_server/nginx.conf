server {
    listen 80;
    server_name _;

    # Set proper MIME types
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # Add proper headers
    add_header X-Frame-Options "SAMEORIGIN";
    add_header X-XSS-Protection "1; mode=block";
    add_header X-Content-Type-Options "nosniff";

    # Handle /admin (without trailing slash) - prevent redirect
    location = /admin {
        # Return a custom response that does an internal rewrite to /admin/index.html
        rewrite ^ /admin/ last;
    }

    # Admin static assets - direct route to admin container
    # This must come BEFORE the /admin/ location to prevent double-prefixing
    location /admin/assets/ {
        # Remove /admin prefix when proxying to the container (since Vite already adds it)
        # The regex captures the part after /admin/assets/ and passes it to the proxy
        rewrite ^/admin/assets/(.*) /assets/$1 break;
        proxy_pass http://admin:80;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Add proper content type headers
        proxy_set_header Accept $http_accept;
        proxy_set_header Accept-Encoding $http_accept_encoding;
        
        # Set proper MIME types for static assets
        include /etc/nginx/mime.types;
        default_type application/octet-stream;
        
        # Add caching headers
        expires 1y;
        add_header Cache-Control "public, max-age=31536000";
    }

    # Admin panel served at /admin/ and any subroutes (from React app)
    location /admin/ {
        # To prevent redirects to localhost/admin, use the internal nginx proxy_pass
        proxy_pass http://admin:80/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        
        # Remove the content transformation that was causing issues
        proxy_redirect off;
    }

    # Route admin API calls to the backend - keeping API calls under /api/v1/admin for consistency
    location /api/v1/admin/ {
        proxy_pass http://indoxrouter-server:8000/api/v1/admin/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # API endpoint proxy to FastAPI backend
    location /api/ {
        proxy_pass http://indoxrouter-server:8000/api/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Add these for WebSocket support if needed
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    # Serve FastAPI docs/site at /
    location / {
        proxy_pass http://indoxrouter-server:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
